<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lambo Gift ‚Äî Plinko</title>
  <style>
    body{font-family:Arial,sans-serif;background:#0b0b0b;color:#fff;text-align:center;padding:16px}
    canvas{background:#111;border:2px solid #ffcc00;border-radius:8px;display:block;margin:12px auto}
    button,input{padding:10px 14px;font-size:16px;border-radius:8px;border:0}
    button{background:#ffcc00;color:#000;cursor:pointer}
    input{width:120px;text-align:center;margin-right:8px}
    #status{margin-top:12px;color:#ffd700}
  </style>
</head>
<body>
  <h1>üéØ Lambo Gift ‚Äî Plinko</h1>

  <div>
    <strong>–ë–∞–ª–∞–Ω—Å: </strong><span id="balance">‚Äî</span> <span style="color:#999">–º–æ–Ω–µ—Ç</span>
  </div>

  <div style="margin-top:10px">
    <input id="bet" type="number" min="1" step="1" value="100" />
    <button id="dropBtn">–ó–∞–ø—É—Å—Ç–∏—Ç—å —à–∞—Ä–∏–∫</button>
  </div>

  <canvas id="plinko" width="400" height="450"></canvas>

  <div id="status"></div>

<script>
(async function(){
  // Telegram WebApp –æ–±—ä–µ–∫—Ç
  const tg = window.Telegram?.WebApp;
  // initDataUnsafe —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–æ–±—Ä–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç user (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –∫–∞–∫ WebApp).
  const userInfo = tg?.initDataUnsafe?.user ?? null;
  const userId = userInfo ? String(userInfo.id) : null;

  const statusEl = document.getElementById('status');
  const balanceEl = document.getElementById('balance');
  const betInput = document.getElementById('bet');
  const dropBtn = document.getElementById('dropBtn');

  if(!userId){
    statusEl.innerText = "‚ö†Ô∏è –û—Ç–∫—Ä–æ–π –∏–≥—Ä—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É '–ò–≥—Ä–∞—Ç—å' –≤ –±–æ—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç.";
    // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –º–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å user_id –≤—Ä—É—á–Ω—É—é
  } else {
    statusEl.innerText = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " + (userInfo.username ? "@"+userInfo.username : userId);
  }

  // —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞ —É —Å–µ—Ä–≤–µ—Ä–∞
  async function loadBalance(){
    if(!userId) return;
    try{
      const res = await fetch('/get_balance', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({user_id: userId})
      });
      const j = await res.json();
      balanceEl.innerText = j.balance;
    }catch(e){
      console.error(e);
      statusEl.innerText = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º";
    }
  }

  // === Plinko canvas (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –≤–∏–∑—É–∞–ª) ===
  const canvas = document.getElementById('plinko');
  const ctx = canvas.getContext('2d');

  const slots = [0, 0.5, 1, 2, 5, 10]; // –º–Ω–æ–∂–∏—Ç–µ–ª–∏
  const slotW = canvas.width / slots.length;
  let ball = null;

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // –≤–µ—Ä—Ö–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫/—Å–µ—Ç–∫—É (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
    // —Ä–∏—Å—É–µ–º —Å–ª–æ—Ç—ã
    for(let i=0;i<slots.length;i++){
      ctx.fillStyle = '#222';
      ctx.fillRect(i*slotW, canvas.height-60, slotW-2, 60);
      ctx.strokeStyle = '#ffcc00';
      ctx.strokeRect(i*slotW, canvas.height-60, slotW-2, 60);
      ctx.fillStyle = '#fff';
      ctx.font = "16px Arial";
      ctx.fillText("x"+slots[i], i*slotW + slotW/2 - 10, canvas.height-28);
    }
    // —à–∞—Ä–∏–∫
    if(ball){
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, 10, 0, Math.PI*2);
      ctx.fillStyle = '#ffcc00';
      ctx.fill();
      ctx.closePath();
    }
  }

  function animateDrop(){
    if(!ball) return;
    ball.vy += 0.4;
    // –Ω–µ–±–æ–ª—å—à–∞—è —Å–ª—É—á–∞–π–Ω–∞—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –¥—Ä–æ–∂—å, —á—Ç–æ–±—ã –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å–∫–æ–∫–∏
    ball.x += ball.vx + (Math.random()-0.5)*1.2;
    ball.y += ball.vy;

    // –µ—Å–ª–∏ –¥–æ—à—ë–ª –¥–æ –∑–æ–Ω—ã —Å–ª–æ—Ç–æ–≤
    if(ball.y >= canvas.height - 70){
      // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–æ—Ç –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ x (–≥—Ä–∞–Ω–∏—Ü—ã)
      const idx = Math.max(0, Math.min(slots.length-1, Math.floor(ball.x / slotW)));
      const multiplier = slots[idx];
      finishRound(multiplier);
      ball = null;
      return;
    }
    draw();
    requestAnimationFrame(animateDrop);
  }

  // –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞—É–Ω–¥–∞: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  async function finishRound(multiplier){
    const bet = parseInt(betInput.value) || 0;
    if(!userId){
      statusEl.innerText = "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç: user_id –Ω–µ –Ω–∞–π–¥–µ–Ω.";
      return;
    }
    statusEl.innerText = `–®–∞—Ä–∏–∫ —É–ø–∞–ª –≤ x${multiplier} ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç...`;

    try{
      const res = await fetch('/update_balance', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: userId, bet: bet, multiplier: multiplier })
      });
      const j = await res.json();
      balanceEl.innerText = j.new_balance ?? j.balance ?? '‚Äî';
      statusEl.innerHTML = `–†–µ–∑—É–ª—å—Ç–∞—Ç: x${multiplier}. –í—ã–∏–≥—Ä—ã—à: ${j.win}. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${j.new_balance ?? j.balance}`;
    }catch(err){
      console.error(err);
      statusEl.innerText = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.";
    }
  }

  // –∫–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞: —Å–æ–∑–¥–∞—ë–º —à–∞—Ä–∏–∫ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ –ø–æ x
  dropBtn.addEventListener('click', async ()=>{
    const bet = parseInt(betInput.value) || 0;
    if(!userId){
      alert("–û—Ç–∫—Ä–æ–π –∏–≥—Ä—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞, –∏–Ω–∞—á–µ –ø—Ä–∏–≤—è–∑–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.");
      return;
    }
    // –ø—Ä–æ–≤–µ—Ä–∏–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥ –±—Ä–æ—Å–∫–æ–º
    try{
      const res = await fetch('/get_balance', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({user_id: userId})
      });
      const j = await res.json();
      const bal = j.balance;
      if(bet <=0 || bet !== Math.floor(bet)){
        alert("–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ).");
        return;
      }
      if(bet > bal){
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.");
        return;
      }
      // —Å–æ–∑–¥–∞—ë–º —à–∞—Ä–∏–∫
      ball = { x: canvas.width/2 + (Math.random()-0.5)*40, y: 30, vx: (Math.random()-0.5)*1.2, vy: 1.5 };
      draw();
      requestAnimationFrame(animateDrop);
    }catch(e){
      console.error(e);
      alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
    }
  });

  // –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
  await loadBalance();
  draw();
})();
</script>
</body>
</html>
